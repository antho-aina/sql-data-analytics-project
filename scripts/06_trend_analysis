/*
===============================================================================
Trend Analysis (Change Over Time)
===============================================================================
Purpose:
    - Understand performance evolution.
	
SQL Functions Used:
    - SUM()
    - DATETRUNC()
    - LAG()
    - GROUP BY , ORDER BY ... ASC/DESC
===============================================================================
*/

-- Is performance increasing or decreasing?
WITH month_performance AS (
SELECT
    DATETRUNC(MONTH, order_date) AS year_month,
    SUM(sales_amount) AS total_sales
FROM gold.fact_sales
WHERE order_date IS NOT NULL
GROUP BY DATETRUNC(MONTH, order_date)
)
SELECT
    year_month,
    total_sales,
    total_sales - LAG(total_sales, 1, total_sales) OVER (ORDER BY year_month) AS sales_difference
FROM month_performance;

-- Do trends differ across product category?

WITH product_category_performance AS (
SELECT
    DATETRUNC(MONTH, order_date) AS year_month,
    category,
    SUM(sales_amount) AS total_sales
FROM gold.fact_sales s
LEFT JOIN gold.dim_products p
    ON s.product_key = p.product_key
WHERE order_date IS NOT NULL
GROUP BY DATETRUNC(MONTH, order_date), category)
SELECT
    year_month,
    category,
    total_sales,
    total_sales - LAG(total_sales, 1, total_sales) OVER (PARTITION BY category ORDER BY year_month) AS sales_difference
FROM product_category_performance;

-- Do trends differ accross gender?
WITH gender_performance AS (
SELECT
    DATETRUNC(MONTH, order_date) AS year_month,
    gender,
    SUM(sales_amount) AS total_sales
FROM gold.fact_sales s
LEFT JOIN gold.dim_customers c
    ON s.customer_key = c.customer_key
WHERE order_date IS NOT NULL
GROUP BY gender, DATETRUNC(MONTH, order_date))
SELECT
    year_month,
    gender,
    total_sales,
    total_sales - LAG(total_sales, 1, total_sales) OVER (PARTITION BY gender ORDER BY year_month) AS sales_difference
FROM gender_performance;

-- Do trends differ accross countries?
WITH coutry_performance AS(
SELECT
    DATETRUNC(MONTH, order_date) AS year_month,
    country,
    SUM(sales_amount) AS total_sales
FROM gold.fact_sales s
LEFT JOIN gold.dim_customers c
    ON s.customer_key = c.customer_key
WHERE order_date IS NOT NULL
GROUP BY country, DATETRUNC(MONTH, order_date))
SELECT
    year_month,
    country,
    total_sales,
    total_sales - LAG(total_sales, 1, total_sales) OVER (PARTITION BY country ORDER BY year_month) AS sales_difference
FROM coutry_performance;
